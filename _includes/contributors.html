<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contributors ‚Äî avannotate-project topic</title>

  <style>
    .contributors {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .contributor {
      width: 18%;
      margin: 1%;
      text-align: center;
      box-sizing: border-box;
    }

    .contributor img {
      border-radius: 50%;
      width: 100px;
      height: 100px;
      display: block;
      margin: 0 auto 0.5rem auto;
    }

    .contributor p {
      margin: 0.2rem 0;
      font-size: 0.8em;
      word-break: break-word;
    }

    .contributor a {
      text-decoration: none;
      color: inherit;
    }

    .contributor-info.username {
      font-weight: bold;
      font-size: 0.85em;
    }

    .contributor-info.commit-count {
      font-size: 0.75em;
    }

    .meta {
      margin: 0.75rem 0;
      font-size: 0.9rem;
      color: #333;
    }

    .error {
      color: #900;
      font-weight: bold;
    }

    @media (max-width: 800px) {
      .contributor { width: 30%; }
    }
    @media (max-width: 500px) {
      .contributor { width: 45%; }
    }
  </style>
</head>
<body>
  <div id="contributors">
    <p>Loading contributors...</p>
  </div>

  <script>
  (async function() {
    const container = document.getElementById('contributors');

    // --- Configuration ---
    const topic = "avannotate-project";
    const reposPerPage = 30; // how many repos to fetch from the search API
    // If you hit rate limits, create a GitHub personal access token (no scopes needed for public data)
    // and paste it here as a string. Example: const GITHUB_TOKEN = "ghp_XXXX";
    // Leave as null to use unauthenticated requests (60/hour).
    const GITHUB_TOKEN = null;

    // --- helper to show messages ---
    function showMessage(html) {
      container.innerHTML = html;
    }

    // --- helper to build fetch headers ---
    function buildHeaders() {
      const headers = {
        "Accept": "application/vnd.github+json"
      };
      if (GITHUB_TOKEN) headers["Authorization"] = `token ${GITHUB_TOKEN}`;
      return headers;
    }

    try {
      showMessage('<p>Searching repositories for topic: <strong>' + topic + '</strong>‚Ä¶</p>');

      // Search repos by topic
      const searchUrl = `https://api.github.com/search/repositories?q=topic:${encodeURIComponent(topic)}&per_page=${reposPerPage}`;
      const searchRes = await fetch(searchUrl, { headers: buildHeaders() });

      // If API returned a non-2xx, read the response JSON/message and display it
      if (!searchRes.ok) {
        let errText = `HTTP ${searchRes.status} ${searchRes.statusText}`;
        try {
          const errJson = await searchRes.json();
          if (errJson && errJson.message) errText += ` ‚Äî ${errJson.message}`;
        } catch (e) { /* ignore */ }
        showMessage(`<p class="error">Error querying GitHub Search API: ${errText}</p>
                     <p class="meta">Tip: add a GitHub token in the file if you hit rate limits.</p>`);
        console.error("Search API failed:", await safeReadJSON(searchRes));
        return;
      }

      const searchData = await searchRes.json();
      if (!searchData.items || !searchData.items.length) {
        showMessage('<p>No repositories found for that topic.</p>');
        return;
      }

      showMessage(`<p>Found ${searchData.total_count || searchData.items.length} repositories (showing up to ${reposPerPage}). Fetching contributors‚Ä¶</p>`);

      // Fetch contributors for each repo (sequential to reduce spike; can be parallel but watch rate limits)
      const allContributors = {}; // keyed by login

      for (const repo of searchData.items) {
        const contributorsUrl = repo.contributors_url + "?per_page=100";
        try {
          const cRes = await fetch(contributorsUrl, { headers: buildHeaders() });

          if (!cRes.ok) {
            // log and continue; show small warning in console
            const txt = `Failed loading contributors for ${repo.full_name}: ${cRes.status} ${cRes.statusText}`;
            console.warn(txt, await safeReadJSON(cRes));
            continue;
          }

          const cData = await cRes.json();
          if (!Array.isArray(cData)) continue;

          cData.forEach(u => {
            if (!allContributors[u.login]) {
              allContributors[u.login] = {
                login: u.login,
                avatar_url: u.avatar_url,
                html_url: u.html_url,
                contributions: u.contributions || 0
              };
            } else {
              allContributors[u.login].contributions += u.contributions || 0;
            }
          });

        } catch (err) {
          console.error(`Network error fetching contributors for ${repo.full_name}:`, err);
        }
      }

      const contributors = Object.values(allContributors);
      if (contributors.length === 0) {
        showMessage('<p>No contributors found across repositories for this topic.</p>');
        return;
      }

      // Optional: sort by contributions desc
      contributors.sort((a,b) => (b.contributions || 0) - (a.contributions || 0));

      // Render UI identical to your original
      container.innerHTML =
        `<div class="meta">Displaying ${contributors.length} unique contributor(s) aggregated from the topic.</div>` +
        `<div class="contributors">` +
        contributors.map(user => `
          <div class="contributor">
            <a href="${user.html_url}" target="_blank" rel="noopener">
              <img src="${user.avatar_url}" alt="@${user.login}'s avatar">
            </a>
            <p class="contributor-info username">
              <a href="${user.html_url}" target="_blank" rel="noopener">@${user.login}</a>
            </p>
            <p class="contributor-info commit-count">
              üõ†Ô∏è ${user.contributions} commit${user.contributions !== 1 ? 's' : ''}
            </p>
          </div>
        `).join('') +
        `</div>`;

    } catch (err) {
      console.error("Unexpected error:", err);
      showMessage(`<p class="error">Unexpected error: ${err && err.message ? err.message : err}</p>`);
    }

    // utility to safely try reading JSON for error logging
    async function safeReadJSON(response) {
      try { return await response.clone().json(); } catch (e) { return null; }
    }
  })();
  </script>
</body>
</html>
